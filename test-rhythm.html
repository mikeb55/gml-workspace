<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Variety Automated Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .test-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-testing {
            background: #f59e0b;
        }

        .status-pass {
            background: #10b981;
        }

        .status-fail {
            background: #ef4444;
        }

        .status-waiting {
            background: #6b7280;
        }

        .test-results {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-line {
            padding: 5px 0;
            border-left: 3px solid transparent;
            padding-left: 10px;
            margin: 5px 0;
        }

        .result-success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .result-error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .result-warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .result-info {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .control-panel {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
        }

        button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        button.primary {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        button.primary:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .summary {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
        }

        .summary h2 {
            margin-bottom: 15px;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .score.perfect {
            color: #10b981;
        }

        .score.good {
            color: #fbbf24;
        }

        .score.poor {
            color: #ef4444;
        }

        iframe {
            display: none;
        }

        .rhythm-visualization {
            display: flex;
            gap: 5px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            overflow-x: auto;
        }

        .note-block {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .note-whole {
            width: 160px;
            background: rgba(239, 68, 68, 0.3);
        }

        .note-half {
            width: 80px;
            background: rgba(245, 158, 11, 0.3);
        }

        .note-quarter {
            width: 40px;
            background: rgba(34, 197, 94, 0.3);
        }

        .note-eighth {
            width: 20px;
            background: rgba(59, 130, 246, 0.3);
        }

        .note-sixteenth {
            width: 10px;
            background: rgba(168, 85, 247, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Automated Rhythm Variety Test üéµ</h1>
        
        <div class="control-panel">
            <button class="primary" onclick="runAllTests()">‚ñ∂ Run All Tests</button>
            <button onclick="testRiffGen()">Test RiffGen</button>
            <button onclick="testQuintet()">Test Quintet</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <!-- Test 1: RiffGen Rhythm Generation -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-title">üìù Test 1: RiffGen Rhythm Generation</div>
                <div class="status-badge status-waiting" id="riffgen-status">Waiting</div>
            </div>
            <div class="test-results" id="riffgen-results">
                <div class="result-line result-info">Ready to test RiffGen rhythm variety...</div>
            </div>
            <div class="rhythm-visualization" id="riffgen-rhythm"></div>
        </div>

        <!-- Test 2: Quintet MusicXML Analysis -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-title">üìù Test 2: Quintet-Composer MusicXML Output</div>
                <div class="status-badge status-waiting" id="quintet-status">Waiting</div>
            </div>
            <div class="test-results" id="quintet-results">
                <div class="result-line result-info">Ready to test Quintet rhythm variety...</div>
            </div>
            <div class="rhythm-visualization" id="quintet-rhythm"></div>
        </div>

        <!-- Test 3: Integration Flow -->
        <div class="test-section">
            <div class="test-header">
                <div class="test-title">üìù Test 3: RiffGen ‚Üí Quintet Integration</div>
                <div class="status-badge status-waiting" id="integration-status">Waiting</div>
            </div>
            <div class="test-results" id="integration-results">
                <div class="result-line result-info">Ready to test integration flow...</div>
            </div>
        </div>

        <!-- Summary -->
        <div class="summary">
            <h2>Test Summary</h2>
            <div class="score" id="score">-/-</div>
            <div id="summary-text">Run tests to see results</div>
        </div>
    </div>

    <!-- Hidden iframes for testing -->
    <iframe id="riffgen-frame" src="./gml-riffgen/index.html"></iframe>
    <iframe id="quintet-frame" src="./quintet-composer/index.html"></iframe>

    <script>
        let testResults = {
            riffgen: null,
            quintet: null,
            integration: null
        };

        function log(testId, message, type = 'info') {
            const resultsDiv = document.getElementById(testId + '-results');
            const line = document.createElement('div');
            line.className = `result-line result-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            resultsDiv.appendChild(line);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateStatus(testId, status) {
            const badge = document.getElementById(testId + '-status');
            badge.className = `status-badge status-${status}`;
            badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        function clearResults() {
            ['riffgen', 'quintet', 'integration'].forEach(test => {
                document.getElementById(test + '-results').innerHTML = 
                    '<div class="result-line result-info">Cleared. Ready for new test...</div>';
                document.getElementById(test + '-rhythm').innerHTML = '';
                updateStatus(test, 'waiting');
            });
            document.getElementById('score').textContent = '-/-';
            document.getElementById('summary-text').textContent = 'Run tests to see results';
        }

        async function testRiffGen() {
            updateStatus('riffgen', 'testing');
            log('riffgen', 'Starting RiffGen rhythm test...', 'info');
            
            const riffgenFrame = document.getElementById('riffgen-frame');
            
            // Send generate command
            riffgenFrame.contentWindow.postMessage({
                type: 'GENERATE',
                params: {
                    measures: 4,
                    density: 5,
                    style: 'bebop'
                }
            }, '*');
            
            log('riffgen', 'Sent GENERATE command to RiffGen', 'info');
            
            // Wait for response
            return new Promise((resolve) => {
                let timeout = setTimeout(() => {
                    log('riffgen', 'Timeout - no response from RiffGen', 'error');
                    updateStatus('riffgen', 'fail');
                    testResults.riffgen = false;
                    resolve(false);
                }, 5000);
                
                function handleMessage(event) {
                    if (event.data.type === 'MELODY_GENERATED' || event.data.type === 'GUITAR_PART_DATA') {
                        clearTimeout(timeout);
                        window.removeEventListener('message', handleMessage);
                        
                        // Analyze rhythm variety
                        const rhythmData = analyzeRhythms(event.data.data);
                        
                        if (rhythmData.variety > 1) {
                            log('riffgen', `‚úÖ Good rhythm variety: ${rhythmData.variety} different durations`, 'success');
                            log('riffgen', `Found: ${rhythmData.types.join(', ')}`, 'success');
                            visualizeRhythm('riffgen', rhythmData.notes);
                            updateStatus('riffgen', 'pass');
                            testResults.riffgen = true;
                            resolve(true);
                        } else {
                            log('riffgen', `‚ùå Poor rhythm variety: only ${rhythmData.variety} duration type(s)`, 'error');
                            log('riffgen', `Only found: ${rhythmData.types.join(', ')}`, 'warning');
                            visualizeRhythm('riffgen', rhythmData.notes);
                            updateStatus('riffgen', 'fail');
                            testResults.riffgen = false;
                            resolve(false);
                        }
                    }
                }
                
                window.addEventListener('message', handleMessage);
            });
        }

        async function testQuintet() {
            updateStatus('quintet', 'testing');
            log('quintet', 'Starting Quintet-Composer rhythm test...', 'info');
            
            const quintetFrame = document.getElementById('quintet-frame');
            
            // Generate in Quintet
            quintetFrame.contentWindow.postMessage({
                type: 'GENERATE',
                source: 'test'
            }, '*');
            
            log('quintet', 'Sent GENERATE command to Quintet', 'info');
            
            // Wait and check for MusicXML
            setTimeout(() => {
                // Request export
                quintetFrame.contentWindow.postMessage({
                    type: 'EXPORT_REQUEST',
                    format: 'musicxml'
                }, '*');
                log('quintet', 'Requested MusicXML export', 'info');
            }, 2000);
            
            return new Promise((resolve) => {
                let timeout = setTimeout(() => {
                    log('quintet', 'Timeout - checking for whole note issue', 'warning');
                    
                    // Check if it's the whole note problem
                    log('quintet', '‚ùå Likely generating only whole notes (duration=1024)', 'error');
                    log('quintet', 'Fix needed in rhythm generation code', 'warning');
                    updateStatus('quintet', 'fail');
                    testResults.quintet = false;
                    resolve(false);
                }, 7000);
                
                function handleMessage(event) {
                    if (event.data.type === 'EXPORT_DATA' && event.data.format === 'musicxml') {
                        clearTimeout(timeout);
                        window.removeEventListener('message', handleMessage);
                        
                        // Parse MusicXML for durations
                        const durations = parseMusicXMLDurations(event.data.data);
                        
                        if (durations.variety > 1) {
                            log('quintet', `‚úÖ Good rhythm variety in MusicXML: ${durations.variety} types`, 'success');
                            log('quintet', `Durations found: ${durations.types.join(', ')}`, 'success');
                            updateStatus('quintet', 'pass');
                            testResults.quintet = true;
                            resolve(true);
                        } else {
                            log('quintet', `‚ùå Only ${durations.variety} duration type(s) in MusicXML`, 'error');
                            log('quintet', `All notes are: ${durations.types[0] || 'whole notes (1024)'}`, 'error');
                            log('quintet', 'Fix: Check rhythm generation in Quintet-Composer', 'warning');
                            updateStatus('quintet', 'fail');
                            testResults.quintet = false;
                            resolve(false);
                        }
                    }
                }
                
                window.addEventListener('message', handleMessage);
            });
        }

        async function testIntegration() {
            updateStatus('integration', 'testing');
            log('integration', 'Testing RiffGen ‚Üí Quintet data flow...', 'info');
            
            // First generate in RiffGen
            const riffgenFrame = document.getElementById('riffgen-frame');
            riffgenFrame.contentWindow.postMessage({
                type: 'GENERATE',
                params: { measures: 2 }
            }, '*');
            
            log('integration', 'Generated melody in RiffGen', 'info');
            
            // Wait then request guitar part
            setTimeout(() => {
                riffgenFrame.contentWindow.postMessage({
                    type: 'GET_GUITAR_PART',
                    source: 'quintet'
                }, '*');
                log('integration', 'Requested guitar part for Quintet', 'info');
            }, 1000);
            
            return new Promise((resolve) => {
                let timeout = setTimeout(() => {
                    log('integration', 'Timeout - integration may have issues', 'error');
                    updateStatus('integration', 'fail');
                    testResults.integration = false;
                    resolve(false);
                }, 5000);
                
                function handleMessage(event) {
                    if (event.data.type === 'GUITAR_PART_DATA') {
                        clearTimeout(timeout);
                        window.removeEventListener('message', handleMessage);
                        
                        if (event.data.data && event.data.data.measures) {
                            log('integration', '‚úÖ Guitar part successfully transmitted', 'success');
                            log('integration', `Contains ${event.data.data.measures.length} measures`, 'success');
                            updateStatus('integration', 'pass');
                            testResults.integration = true;
                            resolve(true);
                        } else {
                            log('integration', '‚ùå Guitar part data incomplete', 'error');
                            updateStatus('integration', 'fail');
                            testResults.integration = false;
                            resolve(false);
                        }
                    }
                }
                
                window.addEventListener('message', handleMessage);
            });
        }

        function analyzeRhythms(data) {
            const durations = new Set();
            const notes = [];
            
            if (data && data.measures) {
                data.measures.forEach(measure => {
                    measure.notes.forEach(note => {
                        if (!note.isRest) {
                            durations.add(note.duration);
                            notes.push(note.duration);
                        }
                    });
                });
            }
            
            const durationNames = {
                1: 'whole',
                0.5: 'half',
                0.25: 'quarter',
                0.125: 'eighth',
                0.0625: 'sixteenth'
            };
            
            return {
                variety: durations.size,
                types: Array.from(durations).map(d => durationNames[d] || `${d}`),
                notes: notes
            };
        }

        function parseMusicXMLDurations(xmlData) {
            // Simple parsing - in real scenario would use DOMParser
            const durationMatches = xmlData.match(/<duration>(\d+)<\/duration>/g) || [];
            const durations = new Set();
            
            durationMatches.forEach(match => {
                const value = parseInt(match.match(/\d+/)[0]);
                durations.add(value);
            });
            
            const durationNames = {
                1024: 'whole',
                512: 'half', 
                256: 'quarter',
                128: 'eighth',
                64: 'sixteenth'
            };
            
            return {
                variety: durations.size,
                types: Array.from(durations).map(d => durationNames[d] || `${d}`)
            };
        }

        function visualizeRhythm(testId, notes) {
            const container = document.getElementById(testId + '-rhythm');
            container.innerHTML = '';
            
            notes.slice(0, 16).forEach(duration => {
                const block = document.createElement('div');
                block.className = 'note-block';
                
                if (duration === 1 || duration === 1024) block.className += ' note-whole';
                else if (duration === 0.5 || duration === 512) block.className += ' note-half';
                else if (duration === 0.25 || duration === 256) block.className += ' note-quarter';
                else if (duration === 0.125 || duration === 128) block.className += ' note-eighth';
                else block.className += ' note-sixteenth';
                
                block.textContent = duration < 2 ? 
                    (duration === 1 ? 'W' : duration === 0.5 ? 'H' : duration === 0.25 ? 'Q' : 'E') :
                    (duration === 1024 ? 'W' : duration === 512 ? 'H' : duration === 256 ? 'Q' : 'E');
                
                container.appendChild(block);
            });
        }

        async function runAllTests() {
            clearResults();
            
            log('riffgen', 'Waiting for apps to load...', 'info');
            log('quintet', 'Waiting for apps to load...', 'info');
            
            // Wait for iframes to load
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Run tests sequentially
            await testRiffGen();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testQuintet();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testIntegration();
            
            // Calculate score
            let passed = 0;
            let total = 3;
            
            if (testResults.riffgen) passed++;
            if (testResults.quintet) passed++;
            if (testResults.integration) passed++;
            
            const scoreElement = document.getElementById('score');
            scoreElement.textContent = `${passed}/${total}`;
            
            if (passed === total) {
                scoreElement.className = 'score perfect';
                document.getElementById('summary-text').textContent = 'üéâ Perfect! All rhythm tests passed!';
            } else if (passed >= 2) {
                scoreElement.className = 'score good';
                document.getElementById('summary-text').textContent = '‚ö†Ô∏è Some issues detected. Check failed tests.';
            } else {
                scoreElement.className = 'score poor';
                document.getElementById('summary-text').textContent = '‚ùå Rhythm variety issues found. Only whole notes being generated.';
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('riffgen', 'Apps loaded. Click "Run All Tests" to begin.', 'success');
                log('quintet', 'Apps loaded. Click "Run All Tests" to begin.', 'success');
                log('integration', 'Ready for testing.', 'success');
            }, 3000);
        });
    </script>
</body>
</html>